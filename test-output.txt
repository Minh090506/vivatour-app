
> vivatour-app@0.1.0 test
> jest

PASS src/__tests__/config/supplier-config.test.ts
  SUPPLIER_TYPES configuration
    âˆš should have 9 supplier types (11 ms)
    âˆš should have 3-character prefixes for all types (13 ms)
    âˆš should include all expected types (3 ms)
    âˆš should have correct prefix mappings (2 ms)
  SUPPLIER_LOCATIONS configuration
    âˆš should have 18 locations (2 ms)
    âˆš should have 2-3 character prefixes for all locations (11 ms)
    âˆš should include key Vietnam locations (1 ms)
    âˆš should include international locations (1 ms)
  PAYMENT_MODELS configuration
    âˆš should have 3 payment models (2 ms)
    âˆš should include all expected models (4 ms)
    âˆš should have labels and descriptions (3 ms)
  removeDiacritics
    âˆš should remove Vietnamese diacritics from A variants (2 ms)
    âˆš should remove Vietnamese diacritics from E variants (2 ms)
    âˆš should remove Vietnamese diacritics from I variants (1 ms)
    âˆš should remove Vietnamese diacritics from O variants (1 ms)
    âˆš should remove Vietnamese diacritics from U variants (1 ms)
    âˆš should remove Vietnamese diacritics from Y variants (1 ms)
    âˆš should convert Ä to D (1 ms)
    âˆš should preserve non-diacritic characters
    âˆš should handle mixed strings (1 ms)
    âˆš should handle empty string (1 ms)
  getNamePrefix
    âˆš should extract first 3 characters from simple name (2 ms)
    âˆš should use first word only (1 ms)
    âˆš should handle Vietnamese names with diacritics (7 ms)
    âˆš should pad short names with X (1 ms)
    âˆš should return XXX for empty name
    âˆš should return XXX for null/undefined
    âˆš should trim whitespace
    âˆš should convert to uppercase (1 ms)
  generateSupplierCode
    âˆš should generate correct code format: TYPE-LOCATION-NAME-SEQUENCE (1 ms)
    âˆš should use XX for missing location (1 ms)
    âˆš should use XX for undefined location (1 ms)
    âˆš should pad sequence to 4 digits (3 ms)
    âˆš should default sequence to 1 (1 ms)
    âˆš should handle Vietnamese names correctly (2 ms)
    âˆš should handle single character name (1 ms)
    âˆš should handle empty name
    âˆš should handle name with only spaces
    âˆš should handle multi-word names (use first word only)
    for each supplier type
      âˆš should use HOT for HOTEL (1 ms)
      âˆš should use RES for RESTAURANT (1 ms)
      âˆš should use TRA for TRANSPORT
      âˆš should use GUI for GUIDE
      âˆš should use VIS for VISA (1 ms)
      âˆš should use VMB for VMB (1 ms)
      âˆš should use CRU for CRUISE (1 ms)
      âˆš should use ACT for ACTIVITY (1 ms)
      âˆš should use OTH for OTHER
    for each location
      âˆš should use HN for HA_NOI
      âˆš should use DN for DA_NANG (1 ms)
      âˆš should use HCM for HO_CHI_MINH (1 ms)
      âˆš should use HL for HA_LONG (1 ms)
      âˆš should use PQ for PHU_QUOC (1 ms)
      âˆš should use TL for THAI_LAN (1 ms)
      âˆš should use CB for CAMBODIA (2 ms)

PASS src/__tests__/config/operator-config.test.ts
  SERVICE_TYPES configuration
    âˆš should have 9 service types (15 ms)
    âˆš should include all expected types (4 ms)
    âˆš should have labels and icons for all types (17 ms)
    âˆš should have correct Vietnamese labels (3 ms)
    âˆš should have valid Lucide icon names (5 ms)
  PAYMENT_STATUSES configuration
    âˆš should have 3 payment statuses (1 ms)
    âˆš should include all expected statuses (6 ms)
    âˆš should have labels and colors for all statuses (2 ms)
    âˆš should have correct Vietnamese labels (2 ms)
    âˆš should have appropriate colors (2 ms)
  HISTORY_ACTIONS configuration
    âˆš should have 6 history action types (2 ms)
    âˆš should include all expected action types (3 ms)
    âˆš should have labels and colors for all actions (3 ms)
    âˆš should have correct Vietnamese labels (1 ms)
    âˆš should have appropriate colors (3 ms)
  DEFAULT_VAT_RATE constant
    âˆš should be 10 (percent) (1 ms)
    âˆš should be a positive number (1 ms)
    âˆš should be less than 100 (reasonable VAT rate) (1 ms)
  Service types alignment with Supplier types
    âˆš should have matching service types with supplier types (2 ms)

PASS src/__tests__/lib/supplier-balance.test.ts
  calculateSupplierBalance
    âˆš should calculate balance correctly with all transaction types (18 ms)
    âˆš should handle zero transactions (new supplier) (33 ms)
    âˆš should handle deposits only (19 ms)
    âˆš should calculate negative balance when costs exceed deposits (34 ms)
    âˆš should handle large numeric values (20 ms)
    âˆš should call Prisma with correct supplier ID (13 ms)
  getSupplierBalanceSummary
    âˆš should return balance summary for all active suppliers (11 ms)
    âˆš should filter by supplier type when provided (12 ms)
    âˆš should return empty results for no active suppliers (11 ms)
    âˆš should count positive and negative balances correctly (8 ms)

  console.error
    Error generating cost report: Error: Database error
        at Object.<anonymous> (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\src\__tests__\api\operator-reports.test.ts:149:52)
        at Promise.finally.completed (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-circus\build\jestAdapterInit.js:1557:28)
        at new Promise (<anonymous>)
        at callAsyncCircusFn (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-circus\build\jestAdapterInit.js:1497:10)
        at _callCircusTest (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-circus\build\jestAdapterInit.js:1007:40)
        at processTicksAndRejections (node:internal/process/task_queues:103:5)
        at _runTest (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-circus\build\jestAdapterInit.js:947:3)
        at C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-circus\build\jestAdapterInit.js:849:7
        at _runTestsForDescribeBlock (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-circus\build\jestAdapterInit.js:862:11)
        at _runTestsForDescribeBlock (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-circus\build\jestAdapterInit.js:857:11)
        at run (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-circus\build\jestAdapterInit.js:761:3)
        at runAndTransformResultsToJestFormat (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-circus\build\jestAdapterInit.js:1918:21)
        at jestAdapter (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-circus\build\runner.js:101:19)
        at runTestInternal (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-runner\build\testWorker.js:275:16)
        at runTest (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-runner\build\testWorker.js:343:7)
        at Object.worker (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-runner\build\testWorker.js:497:12)

    [0m [90m 145 |[39m     })[33m;[39m
     [90m 146 |[39m   } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 147 |[39m     console[33m.[39merror([32m'Error generating cost report:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m             [31m[1m^[22m[39m
     [90m 148 |[39m     [36mconst[39m message [33m=[39m error [36minstanceof[39m [33mError[39m [33m?[39m error[33m.[39mmessage [33m:[39m [32m'Unknown error'[39m[33m;[39m
     [90m 149 |[39m     [36mreturn[39m [33mNextResponse[39m[33m.[39mjson(
     [90m 150 |[39m       { success[33m:[39m [36mfalse[39m[33m,[39m error[33m:[39m [32m`Lá»—i táº¡o bÃ¡o cÃ¡o: ${message}`[39m }[33m,[39m[0m

      at error (src/app/api/reports/operator-costs/route.ts:147:13)
      at Object.<anonymous> (src/__tests__/api/operator-reports.test.ts:152:22)

  console.error
    Error fetching suppliers: Error: Database connection failed
        at Object.<anonymous> (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\src\__tests__\api\suppliers.test.ts:200:52)
        at Promise.finally.completed (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-circus\build\jestAdapterInit.js:1557:28)
        at new Promise (<anonymous>)
        at callAsyncCircusFn (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-circus\build\jestAdapterInit.js:1497:10)
        at _callCircusTest (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-circus\build\jestAdapterInit.js:1007:40)
        at processTicksAndRejections (node:internal/process/task_queues:103:5)
        at _runTest (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-circus\build\jestAdapterInit.js:947:3)
        at C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-circus\build\jestAdapterInit.js:849:7
        at _runTestsForDescribeBlock (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-circus\build\jestAdapterInit.js:862:11)
        at _runTestsForDescribeBlock (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-circus\build\jestAdapterInit.js:857:11)
        at run (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-circus\build\jestAdapterInit.js:761:3)
        at runAndTransformResultsToJestFormat (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-circus\build\jestAdapterInit.js:1918:21)
        at jestAdapter (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-circus\build\runner.js:101:19)
        at runTestInternal (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-runner\build\testWorker.js:275:16)
        at runTest (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-runner\build\testWorker.js:343:7)
        at Object.worker (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-runner\build\testWorker.js:497:12)

    [0m [90m 55 |[39m     [36mreturn[39m [33mNextResponse[39m[33m.[39mjson({ success[33m:[39m [36mtrue[39m[33m,[39m data[33m:[39m result })[33m;[39m
     [90m 56 |[39m   } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 57 |[39m     console[33m.[39merror([32m'Error fetching suppliers:'[39m[33m,[39m error)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 58 |[39m     [36mconst[39m message [33m=[39m error [36minstanceof[39m [33mError[39m [33m?[39m error[33m.[39mmessage [33m:[39m [32m'Unknown error'[39m[33m;[39m
     [90m 59 |[39m     [36mreturn[39m [33mNextResponse[39m[33m.[39mjson(
     [90m 60 |[39m       { success[33m:[39m [36mfalse[39m[33m,[39m error[33m:[39m [32m`Failed to fetch suppliers: ${message}`[39m }[33m,[39m[0m

      at error (src/app/api/suppliers/route.ts:57:13)
      at Object.<anonymous> (src/__tests__/api/suppliers.test.ts:203:22)

  console.error
    Error fetching pending payments: Error: Database error
        at Object.<anonymous> (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\src\__tests__\api\operator-approvals.test.ts:179:52)
        at Promise.finally.completed (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-circus\build\jestAdapterInit.js:1557:28)
        at new Promise (<anonymous>)
        at callAsyncCircusFn (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-circus\build\jestAdapterInit.js:1497:10)
        at _callCircusTest (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-circus\build\jestAdapterInit.js:1007:40)
        at processTicksAndRejections (node:internal/process/task_queues:103:5)
        at _runTest (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-circus\build\jestAdapterInit.js:947:3)
        at C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-circus\build\jestAdapterInit.js:849:7
        at _runTestsForDescribeBlock (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-circus\build\jestAdapterInit.js:862:11)
        at _runTestsForDescribeBlock (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-circus\build\jestAdapterInit.js:857:11)
        at run (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-circus\build\jestAdapterInit.js:761:3)
        at runAndTransformResultsToJestFormat (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-circus\build\jestAdapterInit.js:1918:21)
        at jestAdapter (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-circus\build\runner.js:101:19)
        at runTestInternal (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-runner\build\testWorker.js:275:16)
        at runTest (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-runner\build\testWorker.js:343:7)
        at Object.worker (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-runner\build\testWorker.js:497:12)

    [0m [90m 82 |[39m     [36mreturn[39m [33mNextResponse[39m[33m.[39mjson({ success[33m:[39m [36mtrue[39m[33m,[39m data[33m,[39m summary })[33m;[39m
     [90m 83 |[39m   } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 84 |[39m     console[33m.[39merror([32m'Error fetching pending payments:'[39m[33m,[39m error)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 85 |[39m     [36mconst[39m message [33m=[39m error [36minstanceof[39m [33mError[39m [33m?[39m error[33m.[39mmessage [33m:[39m [32m'Unknown error'[39m[33m;[39m
     [90m 86 |[39m     [36mreturn[39m [33mNextResponse[39m[33m.[39mjson(
     [90m 87 |[39m       { success[33m:[39m [36mfalse[39m[33m,[39m error[33m:[39m [32m`Lá»—i táº£i danh sÃ¡ch: ${message}`[39m }[33m,[39m[0m

      at error (src/app/api/operators/pending-payments/route.ts:84:13)
      at Object.<anonymous> (src/__tests__/api/operator-approvals.test.ts:182:22)

PASS src/__tests__/api/operator-lock.test.ts
  GET /api/operators/lock-period
    âˆš should return lock status for a month (31 ms)
    âˆš should return isFullyLocked=true when all locked (10 ms)
    âˆš should return 400 for invalid month format (7 ms)
    âˆš should return 400 when month is missing (8 ms)
  POST /api/operators/lock-period
    âˆš should lock all operators in a period (12 ms)
    âˆš should return count=0 when no operators to lock (12 ms)
    âˆš should return 400 for invalid month format (10 ms)
    âˆš should return 400 when month is missing (14 ms)
  POST /api/operators/[id]/lock
    âˆš should lock a single operator successfully (13 ms)
    âˆš should return 404 when operator not found (13 ms)
    âˆš should return 400 when already locked (12 ms)
  POST /api/operators/[id]/unlock
    âˆš should unlock a locked operator successfully (15 ms)
    âˆš should return 404 when operator not found (17 ms)
    âˆš should return 400 when not locked (22 ms)
  Lock protection in existing APIs
    âˆš PUT should reject editing locked operator (12 ms)
    âˆš DELETE should reject deleting locked operator (11 ms)
    âˆš APPROVE should reject approving locked operator (9 ms)

  console.error
    Error generating payment report: Error: Database error
        at Object.<anonymous> (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\src\__tests__\api\operator-reports.test.ts:232:53)
        at Promise.finally.completed (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-circus\build\jestAdapterInit.js:1557:28)
        at new Promise (<anonymous>)
        at callAsyncCircusFn (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-circus\build\jestAdapterInit.js:1497:10)
        at _callCircusTest (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-circus\build\jestAdapterInit.js:1007:40)
        at processTicksAndRejections (node:internal/process/task_queues:103:5)
        at _runTest (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-circus\build\jestAdapterInit.js:947:3)
        at C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-circus\build\jestAdapterInit.js:849:7
        at _runTestsForDescribeBlock (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-circus\build\jestAdapterInit.js:862:11)
        at _runTestsForDescribeBlock (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-circus\build\jestAdapterInit.js:857:11)
        at run (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-circus\build\jestAdapterInit.js:761:3)
        at runAndTransformResultsToJestFormat (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-circus\build\jestAdapterInit.js:1918:21)
        at jestAdapter (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-circus\build\runner.js:101:19)
        at runTestInternal (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-runner\build\testWorker.js:275:16)
        at runTest (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-runner\build\testWorker.js:343:7)
        at Object.worker (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-runner\build\testWorker.js:497:12)

    [0m [90m 104 |[39m     })[33m;[39m
     [90m 105 |[39m   } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 106 |[39m     console[33m.[39merror([32m'Error generating payment report:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m             [31m[1m^[22m[39m
     [90m 107 |[39m     [36mconst[39m message [33m=[39m error [36minstanceof[39m [33mError[39m [33m?[39m error[33m.[39mmessage [33m:[39m [32m'Unknown error'[39m[33m;[39m
     [90m 108 |[39m     [36mreturn[39m [33mNextResponse[39m[33m.[39mjson(
     [90m 109 |[39m       { success[33m:[39m [36mfalse[39m[33m,[39m error[33m:[39m [32m`Lá»—i táº¡o bÃ¡o cÃ¡o: ${message}`[39m }[33m,[39m[0m

      at error (src/app/api/reports/operator-payments/route.ts:106:13)
      at Object.<anonymous> (src/__tests__/api/operator-reports.test.ts:235:22)

  console.error
    Error fetching transactions: Error: Database connection failed
        at Object.<anonymous> (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\src\__tests__\api\supplier-transactions.test.ts:226:7)
        at Promise.finally.completed (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-circus\build\jestAdapterInit.js:1557:28)
        at new Promise (<anonymous>)
        at callAsyncCircusFn (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-circus\build\jestAdapterInit.js:1497:10)
        at _callCircusTest (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-circus\build\jestAdapterInit.js:1007:40)
        at processTicksAndRejections (node:internal/process/task_queues:103:5)
        at _runTest (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-circus\build\jestAdapterInit.js:947:3)
        at C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-circus\build\jestAdapterInit.js:849:7
        at _runTestsForDescribeBlock (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-circus\build\jestAdapterInit.js:862:11)
        at _runTestsForDescribeBlock (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-circus\build\jestAdapterInit.js:857:11)
        at run (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-circus\build\jestAdapterInit.js:761:3)
        at runAndTransformResultsToJestFormat (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-circus\build\jestAdapterInit.js:1918:21)
        at jestAdapter (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-circus\build\runner.js:101:19)
        at runTestInternal (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-runner\build\testWorker.js:275:16)
        at runTest (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-runner\build\testWorker.js:343:7)
        at Object.worker (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-runner\build\testWorker.js:497:12)

    [0m [90m 47 |[39m     })[33m;[39m
     [90m 48 |[39m   } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 49 |[39m     console[33m.[39merror([32m'Error fetching transactions:'[39m[33m,[39m error)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 50 |[39m     [36mreturn[39m [33mNextResponse[39m[33m.[39mjson(
     [90m 51 |[39m       { success[33m:[39m [36mfalse[39m[33m,[39m error[33m:[39m [32m'Failed to fetch transactions'[39m }[33m,[39m
     [90m 52 |[39m       { status[33m:[39m [35m500[39m }[0m

      at error (src/app/api/supplier-transactions/route.ts:49:13)
      at Object.<anonymous> (src/__tests__/api/supplier-transactions.test.ts:230:22)

PASS src/__tests__/api/operator-reports.test.ts
  GET /api/reports/operator-costs
    âˆš should return cost report grouped by service type, supplier, and month (66 ms)
    âˆš should filter by date range (12 ms)
    âˆš should filter by service type (9 ms)
    âˆš should handle empty data gracefully (10 ms)
    âˆš should handle database errors (135 ms)
    âˆš should reject invalid date format (6 ms)
    âˆš should reject invalid service type (6 ms)
  GET /api/reports/operator-payments
    âˆš should return payment status summary (6 ms)
    âˆš should handle null totals gracefully (4 ms)
    âˆš should handle database errors (17 ms)
    âˆš should reject invalid month format (9 ms)

PASS src/__tests__/api/operator-approvals.test.ts
  GET /api/operators/pending-payments
    âˆš should return pending payments with success (30 ms)
    âˆš should filter by overdue (11 ms)
    âˆš should filter by today (7 ms)
    âˆš should filter by week (8 ms)
    âˆš should filter by serviceType (8 ms)
    âˆš should calculate daysOverdue correctly (12 ms)
    âˆš should return correct summary (5 ms)
    âˆš should return 500 on database error (144 ms)
  POST /api/operators/approve (batch)
    âˆš should batch approve operators successfully (8 ms)
    âˆš should return 400 when no operatorIds provided (6 ms)
    âˆš should return 400 when paymentDate is missing (6 ms)
    âˆš should return 404 when some operators not found (13 ms)
    âˆš should return 403 when trying to approve locked operators (10 ms)
  POST /api/operators/[id]/approve (single)
    âˆš should approve single operator successfully (21 ms)
    âˆš should return 404 when operator not found (25 ms)
    âˆš should return 403 when operator is locked (31 ms)
    âˆš should return 400 when already paid (12 ms)
    âˆš should use current date when paymentDate not provided (12 ms)

  console.error
    Error creating supplier: Error: Database write failed
        at Object.<anonymous> (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\src\__tests__\api\suppliers.test.ts:528:50)
        at Promise.finally.completed (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-circus\build\jestAdapterInit.js:1557:28)
        at new Promise (<anonymous>)
        at callAsyncCircusFn (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-circus\build\jestAdapterInit.js:1497:10)
        at _callCircusTest (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-circus\build\jestAdapterInit.js:1007:40)
        at processTicksAndRejections (node:internal/process/task_queues:103:5)
        at _runTest (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-circus\build\jestAdapterInit.js:947:3)
        at C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-circus\build\jestAdapterInit.js:849:7
        at _runTestsForDescribeBlock (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-circus\build\jestAdapterInit.js:862:11)
        at _runTestsForDescribeBlock (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-circus\build\jestAdapterInit.js:857:11)
        at run (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-circus\build\jestAdapterInit.js:761:3)
        at runAndTransformResultsToJestFormat (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-circus\build\jestAdapterInit.js:1918:21)
        at jestAdapter (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-circus\build\runner.js:101:19)
        at runTestInternal (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-runner\build\testWorker.js:275:16)
        at runTest (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-runner\build\testWorker.js:343:7)
        at Object.worker (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-runner\build\testWorker.js:497:12)

    [0m [90m 148 |[39m     [36mreturn[39m [33mNextResponse[39m[33m.[39mjson({ success[33m:[39m [36mtrue[39m[33m,[39m data[33m:[39m supplier }[33m,[39m { status[33m:[39m [35m201[39m })[33m;[39m
     [90m 149 |[39m   } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 150 |[39m     console[33m.[39merror([32m'Error creating supplier:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m             [31m[1m^[22m[39m
     [90m 151 |[39m     [36mconst[39m message [33m=[39m error [36minstanceof[39m [33mError[39m [33m?[39m error[33m.[39mmessage [33m:[39m [32m'Unknown error'[39m[33m;[39m
     [90m 152 |[39m     [36mreturn[39m [33mNextResponse[39m[33m.[39mjson(
     [90m 153 |[39m       { success[33m:[39m [36mfalse[39m[33m,[39m error[33m:[39m [32m`Lá»—i táº¡o NCC: ${message}`[39m }[33m,[39m[0m

      at error (src/app/api/suppliers/route.ts:150:13)
      at Object.<anonymous> (src/__tests__/api/suppliers.test.ts:538:22)

PASS src/__tests__/api/suppliers.test.ts
  GET /api/suppliers
    âˆš should return all suppliers with success response (35 ms)
    âˆš should filter by search term (code or name) (8 ms)
    âˆš should filter by type (8 ms)
    âˆš should filter by location (9 ms)
    âˆš should filter by paymentModel (9 ms)
    âˆš should filter by isActive=true (6 ms)
    âˆš should filter by isActive=false (5 ms)
    âˆš should handle multiple filters combined (6 ms)
    âˆš should include balance when includeBalance=true (9 ms)
    âˆš should return 500 on database error (146 ms)
    âˆš should return empty array when no suppliers found (7 ms)
  POST /api/suppliers
    âˆš should create supplier with valid data (7 ms)
    âˆš should return 400 when name is missing (9 ms)
    âˆš should return 400 when type is missing (14 ms)
    âˆš should return 400 for invalid supplier type (11 ms)
    âˆš should return 400 when code already exists (11 ms)
    âˆš should auto-generate code when not provided (16 ms)
    âˆš should increment sequence for existing prefix (32 ms)
    âˆš should default paymentModel to PREPAID (10 ms)
    âˆš should default isActive to true (8 ms)
    âˆš should trim text fields (15 ms)
    âˆš should convert creditLimit to number (15 ms)
    âˆš should return 500 on database error (38 ms)

PASS src/__tests__/lib/request-utils.test.ts
  generateRQID
    âˆš should generate RQID with correct format RQ-YYMMDD-XXXX (29 ms)
    âˆš should pad sequence number with zeros (38 ms)
    âˆš should pad sequence to 4 digits for count 999 (15 ms)
    âˆš should query requests created today (23 ms)
  generateBookingCode - Phase 1 Schema Changes
    with explicit sellerCode
      âˆš should use sellerCode when available (6 ms)
      âˆš should accept single char sellerCode (30 ms)
      âˆš should handle multi-char sellerCode (edge case) (11 ms)
    fallback to sellerName first letter
      âˆš should use first letter of name when sellerCode is null (9 ms)
      âˆš should uppercase first letter of name (6 ms)
      âˆš should handle single character name (10 ms)
    ultimate fallback to X
      âˆš should use X when no sellerCode and no name (9 ms)
      âˆš should use X when config user not found (9 ms)
      âˆš should use X when user object is missing (10 ms)
    sequence numbering
      âˆš should increment sequence for same date and code (16 ms)
      âˆš should start at 0001 when no existing codes (10 ms)
      âˆš should pad sequence with zeros (8 ms)
      âˆš should handle max 4-digit sequence (9999) (37 ms)
    date formatting
      âˆš should format date as YYYYMMDD (35 ms)
      âˆš should pad month and day with zeros (16 ms)
      âˆš should handle December dates (9 ms)
    existing booking codes preservation
      âˆš should not modify existing booking codes (8 ms)
      âˆš should query correctly with startsWith filter (11 ms)
  calculateEndDate
    âˆš should calculate end date as startDate + tourDays - 1 (11 ms)
    âˆš should handle single day tour (10 ms)
    âˆš should handle two day tour (12 ms)
    âˆš should handle long tour (cross month) (15 ms)
    âˆš should not mutate original date (10 ms)
  calculateNextFollowUp
    âˆš should calculate next follow-up date based on config (19 ms)
    âˆš should return null when config is not found (10 ms)
    âˆš should return null when config is inactive (8 ms)
    âˆš should handle 0 days to wait (13 ms)
    âˆš should handle large days to wait (20 ms)
  getSellerCode
    âˆš should return seller code when available (40 ms)
    âˆš should return null when seller code is null (14 ms)
    âˆš should return null when config not found (14 ms)
    âˆš should call findUnique with correct userId (14 ms)
  canUserViewAll
    âˆš should return true when canViewAll is true (24 ms)
    âˆš should return false when canViewAll is false (14 ms)
    âˆš should return false when config not found (12 ms)
  getFollowUpDateBoundaries
    âˆš should return today start and end dates (11 ms)
    âˆš todayStart should be at 00:00:00 (10 ms)
    âˆš todayEnd should be at 23:59:59.999 (8 ms)
    âˆš threeDaysLater should be 3 days after todayStart (7 ms)
    âˆš should have same date for todayStart and todayEnd (9 ms)

  console.error
    Error creating transaction: Error: Database write failed
        at Object.<anonymous> (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\src\__tests__\api\supplier-transactions.test.ts:592:61)
        at Promise.finally.completed (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-circus\build\jestAdapterInit.js:1557:28)
        at new Promise (<anonymous>)
        at callAsyncCircusFn (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-circus\build\jestAdapterInit.js:1497:10)
        at _callCircusTest (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-circus\build\jestAdapterInit.js:1007:40)
        at processTicksAndRejections (node:internal/process/task_queues:103:5)
        at _runTest (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-circus\build\jestAdapterInit.js:947:3)
        at C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-circus\build\jestAdapterInit.js:849:7
        at _runTestsForDescribeBlock (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-circus\build\jestAdapterInit.js:862:11)
        at _runTestsForDescribeBlock (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-circus\build\jestAdapterInit.js:857:11)
        at run (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-circus\build\jestAdapterInit.js:761:3)
        at runAndTransformResultsToJestFormat (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-circus\build\jestAdapterInit.js:1918:21)
        at jestAdapter (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-circus\build\runner.js:101:19)
        at runTestInternal (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-runner\build\testWorker.js:275:16)
        at runTest (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-runner\build\testWorker.js:343:7)
        at Object.worker (C:\Users\Admin\Projects\company-workflow-app\vivatour-app\node_modules\jest-runner\build\testWorker.js:497:12)

    [0m [90m 118 |[39m     [36mreturn[39m [33mNextResponse[39m[33m.[39mjson({ success[33m:[39m [36mtrue[39m[33m,[39m data[33m:[39m transaction }[33m,[39m { status[33m:[39m [35m201[39m })[33m;[39m
     [90m 119 |[39m   } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 120 |[39m     console[33m.[39merror([32m'Error creating transaction:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m             [31m[1m^[22m[39m
     [90m 121 |[39m     [36mreturn[39m [33mNextResponse[39m[33m.[39mjson(
     [90m 122 |[39m       { success[33m:[39m [36mfalse[39m[33m,[39m error[33m:[39m [32m'Failed to create transaction'[39m }[33m,[39m
     [90m 123 |[39m       { status[33m:[39m [35m500[39m }[0m

      at error (src/app/api/supplier-transactions/route.ts:120:13)
      at Object.<anonymous> (src/__tests__/api/supplier-transactions.test.ts:599:22)

PASS src/__tests__/api/supplier-transactions.test.ts
  GET /api/supplier-transactions
    âˆš should return all transactions with success response (34 ms)
    âˆš should filter by supplierId (14 ms)
    âˆš should filter by transaction type (12 ms)
    âˆš should filter by date range (fromDate only) (9 ms)
    âˆš should filter by date range (toDate only) (7 ms)
    âˆš should filter by date range (both fromDate and toDate) (9 ms)
    âˆš should paginate with limit and offset (6 ms)
    âˆš should default limit to 50 (8 ms)
    âˆš should return hasMore=true when more records exist (9 ms)
    âˆš should include supplier details in response (9 ms)
    âˆš should order by transactionDate desc (9 ms)
    âˆš should return 500 on database error (144 ms)
  POST /api/supplier-transactions
    âˆš should create transaction with valid data (55 ms)
    âˆš should return 400 when supplierId is missing (16 ms)
    âˆš should return 400 when type is missing (14 ms)
    âˆš should return 400 when amount is missing (12 ms)
    âˆš should return 400 when transactionDate is missing (13 ms)
    âˆš should return 400 when amount is zero (17 ms)
    âˆš should return 400 when amount is negative (17 ms)
    âˆš should return 404 when supplier not found (18 ms)
    âˆš should convert amount to number (6 ms)
    âˆš should parse transactionDate as Date (8 ms)
    âˆš should default createdBy to system (7 ms)
    âˆš should use provided createdBy (8 ms)
    âˆš should include optional fields when provided (8 ms)
    âˆš should return 500 on database error (25 ms)
    transaction type validation
      âˆš should accept valid type: DEPOSIT (17 ms)
      âˆš should accept valid type: REFUND (13 ms)
      âˆš should accept valid type: ADJUSTMENT (10 ms)
      âˆš should accept valid type: FEE (20 ms)
      âˆš should return 400 for invalid type (13 ms)

Test Suites: 9 passed, 9 total
Tests:       228 passed, 228 total
Snapshots:   0 total
Time:        5.067 s
Ran all test suites.
